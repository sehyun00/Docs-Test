# 종목 관리

## 요약 ⚡

- 한국투자증권 API를 통한 종목 검색 및 실시간 시세 조회
- 포트폴리오별 종목 추가/수정/삭제 (CRUD)
- 보유 수량 관리: Phase 1은 정수만, Phase 2부터 소수점 4자리 지원
- 실시간 시세: 장중 30초~1분 간격 자동 갱신, API 호출 최적화
- [P2-고려] 소수점 거래 지원을 위해 DB 컬럼은 `DECIMAL(18,4)` 타입 사용

---

## Phase 1 (현재)

### 기능 목록

- [P1] 종목 검색 (한국투자증권 API)
- [P1] 종목 추가 (보유 수량 입력 + 목표 비중)
- [P1] 종목 수정 (수량, 목표 비율 변경)
- [P1] 종목 삭제 (스와이프 또는 편집 모드)
- [P1] 실시간 시세 조회 및 자동 갱신
- [P1] 데이터 캐싱 (30초 TTL, API 호출 최소화)

### 종목 검색

| 항목 | 규칙 |
|------|------|
| 검색 방법 | 종목명 또는 종목코드로 검색 |
| API | 한국투자증권 API (종목 조회) |
| 검색 결과 | 종목명, 종목코드, 현재가 표시 |
| 응답 시간 | < 1초 |
| 에러 처리 | 검색 실패 시 "검색 결과가 없습니다" 표시 |

### 종목 추가

| 항목 | 규칙 |
|------|------|
| 필수 입력 | 보유 수량 (정수, 1주 이상), **목표 비중** |
| 선택 입력 | 매수 단가 |
| 중복 체크 | 동일 포트폴리오 내 동일 종목 중복 불가 |
| 중복 시 동작 | "이미 추가된 종목입니다. 수정하시겠습니까?" 다이얼로그 |
| 최대 개수 | 포트폴리오당 최대 50종목 |

**입력 검증**

```javascript
// 보유 수량 검증 (Phase 1)
quantity: {
  type: "integer",
  min: 1,
  max: 100000000, // 1억주
  required: true
}

// 목표 비율 검증
targetRatio: {
  type: "decimal",
  min: 0,
  max: 100,
  precision: 1, // 소수점 1자리
  required: true // P1 필수
}

// 목표 비중 유효성 검사 (Validation)
// 목표 비중의 합은 100%를 초과할 수 없음
// 입력 가능 비중 = 100% - (기존 종목 목표 비중 총합)
// 초과 입력 시 경고 문구 노출 및 저장 불가
```

### 종목 수정

| 항목 | 규칙 |
|------|------|
| 수정 가능 항목 | 보유 수량, 목표 비율 |
| 수량 변경 | 1 이상의 정수 |
| 비율 변경 | 0~100% (소수점 첫째 자리), 전체 합 100% 내에서 자유롭게 조정 |
| 저장 시점 | 수정 즉시 서버 동기화 |

### 종목 삭제

| 항목 | 규칙 |
|------|------|
| 삭제 방식 | 스와이프 제스처 또는 편집 모드 |
| 확인 절차 | "삭제하시겠습니까?" 다이얼로그 (실수 방지) |
| 삭제 효과 | 삭제된 종목의 목표 비중은 '미설정(현금)' 비중으로 전환 |
| 최소 보유 | 포트폴리오당 최소 0종목 (빈 포트폴리오 허용) |

### 실시간 시세 조회

| 항목 | 규칙 |
|------|------|
| 업데이트 주기 (장중) | 30초~1분 간격 자동 갱신 |
| 업데이트 주기 (장외) | 수동 새로고침 (Pull to Refresh) |
| 백그라운드 모드 | 업데이트 중단 (배터리 절약) |
| 캐시 TTL | 30초 (메모리 캐시) |
| API 호출 최적화 | 현재 화면 표시 종목만 조회 |

**시세 데이터 구조**

```javascript
{
  stockCode: "005930",
  stockName: "삼성전자",
  currentPrice: 70000,
  changeRate: 2.5,        // 등락률 (%)
  changeAmount: 1700,     // 등락가 (원)
  volume: 15000000,       // 거래량
  timestamp: "2026-01-15T14:30:00Z"
}
```

### 데이터 캐싱 전략

| 항목 | 값 |
|------|-----|
| Phase 1 | 앱 메모리 캐시 (React Native) |
| 캐시 키 | `stock:price:{stockCode}` |
| TTL | 30초 |
| 갱신 조건 | 캐시 만료 또는 수동 새로고침 |
| 예상 효과 | API 호출 30~40% 감소 |

---

## Phase 2+ (확장 고려사항)

### Phase 2 기능

- [P2] **소수점 거래 지원** (토스증권 등)
  - 보유 수량: 소수점 4자리까지 (예: 0.0331주)
  - 최소 수량: 0.0001주
  - DB 컬럼: `DECIMAL(18,4)` (Phase 1부터 적용 권장)
  
- [P2] **평균 매입 단가 입력**
  - 선택 입력 항목: 평균 매입 단가, 총 매입 금액, 매입일
  - 수익률 계산: (현재가 - 평균 단가) / 평균 단가 × 100
  - DB에 `avg_purchase_price`, `total_purchase_amount`, `purchase_date` 컬럼 추가 필요

- [P2] **배치 시세 조회**
  - 한 번의 API 요청으로 여러 종목 시세 조회
  - API 호출 50~60% 감소 예상
  - 한국투자증권 API 지원 여부 확인 필요

### Phase 3 기능

- [P3] **종목 상세 정보**
  - 차트, 재무제표, 뉴스 등 (외부 API 연동)
  - 별도 상세 화면 구성

- [P3] **종목 즐겨찾기**
  - 자주 거래하는 종목 즐겨찾기 기능
  - 빠른 추가 위젯

- [P3] **해외 주식 지원**
  - 미국 주식 등 (별도 API 필요)
  - 환율 변환 로직 추가

---

## 에러 처리

### API 에러

| 에러 케이스 | 처리 방법 |
|------------|----------|
| 검색 API 실패 | "검색 결과를 불러올 수 없습니다" 토스트 + 재시도 버튼 |
| 시세 API 실패 | 마지막 캐시 데이터 표시 + "업데이트 실패" 표시 |
| 네트워크 오류 | 오프라인 모드 전환 + 캐시 데이터 사용 |
| 429 Rate Limit | "잠시 후 다시 시도해주세요" + 자동 재시도 (5초 후) |

### 입력 검증 에러

| 에러 케이스 | 메시지 |
|------------|--------|
| 수량 0 이하 | "보유 수량은 1주 이상이어야 합니다" |
| 수량이 정수 아님 | "Phase 1에서는 정수만 입력 가능합니다" (Phase 2부터 소수점) |
| 목표 비율 범위 초과 | "목표 비율은 0~100% 사이여야 합니다" |
| 중복 종목 | "이미 추가된 종목입니다" |

---

## 성능 목표

| 지표 | 목표 |
|------|------|
| 종목 검색 응답 | < 1초 |
| 시세 조회 응답 | < 500ms |
| 종목 추가/수정/삭제 | < 300ms |
| 화면 로딩 시간 | < 1.5초 |
| API 호출 캐시 적중률 | > 60% |

---

## 관련 문서

- **포트폴리오**: `features/portfolio.md` - 종목이 속한 포트폴리오 구조
- **리밸런싱**: `features/rebalancing.md` - 종목 비율 계산 로직
- **DB 스키마**: `reference/db-schema.md#stocks` - stocks 테이블 구조
- **API 명세**: `reference/api-spec.md#stock-api` - 종목 관련 엔드포인트
- **한투 API**: `core/tech-stack.md#한국투자증권-api` - API 연동 방법

---

> **작성일**: 2025-12-31  
> **Phase**: Phase 1 (MVP)  
> **담당**: Backend + Frontend
